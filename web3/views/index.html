<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>NFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/mint-ui/lib/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    html, body, #app {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    .content {
      height: calc(100% - 50px); 
      overflow-y: auto;
      padding: 15px;
      box-sizing: border-box;
    }
    .card-wrapper {
      margin-top: 15px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; 
      gap: 10px;
      margin-top: 10px;
    }
    .stat-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #409EFF;
      margin-top: 5px;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="content">
    <div v-if="activeTab === 'home'" style="height:100%;">
      <mt-loadmore :top-method="loadTop" :auto-fill="true" ref="loadmore" style="height:100%;">
        <div>
          <h2>首页</h2>
          <div class="stats-grid">
            <div class="stat-card" v-for="(item, index) in stats" :key="index">
              <div class="stat-label">{{ item.label }}</div>
              <div class="stat-value" :id="'stat-' + item.name"></div>
            </div>
          </div>
          <div style="padding: 15px;">
            <mt-button type="primary" size="large" @click="popupMintNFTVisible=true">
                <template v-if="mintLoading">
                  <i class="mt-icon-loading"></i> 铸造中...
                </template>
                <template v-else>
                  开始铸造
                </template>
            </mt-button>
            <mt-popup :style="{width: '100%'}" v-model="popupMintNFTVisible" position="bottom">
                <div  class="content">
                  <mt-header :style="{ backgroundColor: 'unset', color: '#222' }" title="铸造 NFT"></mt-header>
                  <div style="margin: 10px 0;">
                    <mt-field v-model.number="mintQuantity" type="number" placeholder="输入数量" label="数量" :min="1"></mt-field>
                  </div>
                  <mt-button :disabled="mintLoading" type="primary" size="large" @click="mintNFT(mintQuantity)">
                    <template v-if="mintLoading">
                      <i class="mt-icon-loading"></i> 铸造中...
                    </template>
                    <template v-else>
                      铸造
                    </template>
                  </mt-button>
                </div>
            </mt-popup>
          </div>
        </div>
      </mt-loadmore>
    </div>
    <div v-if="activeTab === 'me'" style="height:100%;">
      <mt-loadmore :top-method="meLoadTop" :auto-fill="true" ref="meLoadmore" style="height:100%;">
        <div>
          <h2>我的</h2>
          <div v-if="account">
            <mt-cell title="账户地址">
              <span style="color:gray;"> {{ account ? account.slice(0,24) + '...' : '' }}</span>
            </mt-cell>
            <mt-cell title="余额 (ETH)">
              <span style="color:gray;">{{ balance }}</span>
            </mt-cell>
            <mt-cell title="持有NFT（个）">
              <span style="color:gray;">{{ nftList.length }}</span>
            </mt-cell>
            <div style="padding: 15px;">
              <mt-button type="danger" size="large" @click="disconnectWallet">
                断开钱包
              </mt-button>
            </div>
          </div>
          <div v-else style="padding: 15px;">
            <mt-button type="primary" size="large" @click="connectWallet">
              连接钱包
            </mt-button>
          </div>
        </div>
      </mt-loadmore>
    </div>
  </div>
  <mt-tabbar v-model="activeTab">
    <mt-tab-item id="home">
        <i slot="icon" class="fas fa-home"></i>
        <span>首页</span>
    </mt-tab-item>
    <mt-tab-item id="me">
        <i slot="icon" class="fas fa-user"></i>
        <span>我的</span>
    </mt-tab-item>
  </mt-tabbar>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/mint-ui/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/countup.js@2.6.2/dist/countUp.umd.js"></script>
<script>
  const contractABI = [{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_symbol","type":"string"},{"internalType":"uint256","name":"_maxSupply","type":"uint256"},{"internalType":"uint256","name":"_mintPrice","type":"uint256"},{"internalType":"uint256","name":"_maxPerTx","type":"uint256"},{"internalType":"uint256","name":"_maxPerWallet","type":"uint256"},{"internalType":"string","name":"_unrevealedURI","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"baseURI","type":"string"}],"name":"BaseURISet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"minter","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Minted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"revealed","type":"bool"}],"name":"Revealed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"active","type":"bool"}],"name":"SaleToggled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"unrevealedURI","type":"string"}],"name":"UnrevealedURISet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"active","type":"bool"}],"name":"WhitelistToggled","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"hide","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxPerTx","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxPerWallet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"merkleRoot","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mintPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"mintedPerWallet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"ownerMint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"publicMint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"reveal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"revealed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"saleActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_baseURI","type":"string"}],"name":"setBaseURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_maxPerTx","type":"uint256"}],"name":"setMaxPerTx","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_maxPerWallet","type":"uint256"}],"name":"setMaxPerWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_maxSupply","type":"uint256"}],"name":"setMaxSupply","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"_root","type":"bytes32"}],"name":"setMerkleRoot","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_mintPrice","type":"uint256"}],"name":"setMintPrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_unrevealedURI","type":"string"}],"name":"setUnrevealedURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"toggleSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"toggleWhitelist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unrevealedURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"whitelistActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"bytes32[]","name":"proof","type":"bytes32[]"}],"name":"whitelistMint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address payable","name":"to","type":"address"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
  const contractAddress = "0xb8cD5FC286922c54AB32A8AaBF583E382b44F050";
  new Vue({
    el: '#app',
    data: {
      activeTab: 'home',
      mintQuantity: 1,
      mintLoading: false, 
      popupMintNFTVisible: false,
      stats: [
        { label: '交易总数', value: 0 },
        { label: '活跃用户', value: 0 },
        { label: 'NFT 铸造', value: 0 },
        { label: '转账次数', value: 0 }
      ],
      account: null,
      balance: null,
      web3: null,
      contract: null,
      es: null,
      nftList: [],
      occurred: [],
    },
    watch: {
      activeTab(newVal) {
        switch (newVal) {
          case 'home':
            this.$nextTick(() => {
              this.stats.forEach(stat => {
                this.runCountUp(stat.name, stat.value - 1, stat.value)
              })
            })
            break;
          case 'me':
            if(!this.nftList.length) {
              this.loadMyNFTs();
            }
            break;
        }
      },
      stats: {
        deep: true,
        handler(newStats, oldStats) {
          let occurredName = this.occurred.pop()
          this.$nextTick(() => {
            newStats.forEach((stat, index) => {
              if (occurredName=== undefined || occurredName === stat.name) {
                this.runCountUp(stat.name, oldStats[index] ? oldStats[index].value : 0, stat.value);
              }
            });
          });
        }
      }
    },
    async mounted() {
      this.flushStat();
      if (!window.ethereum) {
        this.$toast('未检测到 MetaMask，请先安装');
        return
      }
      this.web3 = new Web3(window.ethereum);
      let walletConnected = localStorage.getItem('wallet_connected')
      if (walletConnected === 'true') {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length) {
          this.setAccount(accounts[0]);
        }
      }
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length) {
          this.setAccount(accounts[0]);
        } else {
          this.account = null;
          this.balance = null;
        }
      });
      window.ethereum.on('chainChanged', () => {
        window.location.reload();
      });
      
      this.contract = new this.web3.eth.Contract(contractABI, contractAddress);
    },
    methods: {
      async mintNFT(quantity) {
        try {
          this.mintLoading = true;
          const mintPrice = await this.contract.methods.mintPrice().call();
          const totalPrice = BigInt(mintPrice) * BigInt(quantity); // 总价
          const tx = await this.contract.methods.publicMint(quantity).send({
            from: this.account,
            value: totalPrice.toString()  // wei 单位
          });
          this.$toast('铸造成功');
        } catch (err) {
          console.error('铸造失败', err);
          this.$toast('铸造失败');
        } finally {
          this.mintLoading = false;
        }
      },
      flushStat() {
          if (this.es) {
            this.es.close();
            this.es = null;
          }
          this.es = new EventSource('/api/sse/occurred')
          this.es.addEventListener('data', event => {
              let data = JSON.parse(event.data);
              switch (data.type) {
                  case "stats":
                      this.stats = data.data;
                      break;
                  case "occurred":
                      let occurred = data.data;
                      for (let i = 0; i < this.stats.length; i++) {
                          let s = this.stats[i];
                          if (s.name === occurred.name) {
                              this.stats[i].value += occurred.value;
                              this.occurred.push(occurred.name);
                          }
                      }
                      break;
              }
          });
      },
      loadTop() {
        this.flushStat()
        setTimeout(() => {
          this.$refs.loadmore.onTopLoaded()
        }, 700)
      },
      meLoadTop() {
        setTimeout(() => {
          this.$refs.meLoadmore.onTopLoaded()
        }, 700)
      },
      runCountUp(name, start, end, cb = () => {}) {
        const options = {
          startVal: 0,
          onCompleteCallback: cb,
          duration: 1,
        };
        let cu = new countUp.CountUp('stat-' + name, end, options);
        if (!cu.error) {
          cu.start();
        } else {  
          console.error(cu.error);
        }
      },
      async connectWallet() {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          this.setAccount(accounts[0]);
          localStorage.setItem('wallet_connected', 'true');
          this.$toast('钱包连接成功！');
        } catch (err) {
          console.error(err);
          this.$toast('连接钱包失败');
        }
      },
      disconnectWallet() {
        this.account = null;
        this.balance = '0';
        localStorage.removeItem('wallet_connected'); 
        this.$toast('已断开钱包');
      },
      async setAccount(account) {
        this.account = account;
        const balanceWei = await this.web3.eth.getBalance(account);
        this.balance = this.web3.utils.fromWei(balanceWei, 'ether');
      },
      async loadMyNFTs() {
        if (!this.contract || !this.account) return;
        const balance = await this.contract.methods.balanceOf(this.account).call();
        const list = [];
        for (let i = 0; i < balance; i++) {
          const tokenId = await this.contract.methods.tokenOfOwnerByIndex(this.account, i).call();
          const tokenURI = await this.contract.methods.tokenURI(tokenId).call();
          list.push({ tokenId, tokenURI });
        }
        this.nftList = list;
      }
    }
  });
</script>
</body>
</html>
